---
title: "Replicate paper draft"
author: "Xiaona Zhou"
date: "6/23/2020"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    toc: yes
    toc_depth: 3
---

```{r setup, include=FALSE}
library(scales)
library(tidyverse)
library(plotly)
library(lubridate)
library(broom)
library(modelr)
library(readxl)
library(zoo)
theme_set(theme_bw())

knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
We are replicating the result from paper [Predicting the Present with Google Trends.](http://people.ischool.berkeley.edu/~hal/Papers/2011/ptp.pdf)


# Obtain the data
We first used the [link](https://www.census.gov/retail/marts/www/timeseries.html) provided in the paper, but the data is adjusted. We were able to find the unadjusted data through this [link](https://www.census.gov/econ/currentdata/dbsearch?program=MARTS&startYear=2004&endYear=2020&categories%5B%5D=441&dataType=SM&geoLevel=US&notAdjusted=1&submit=GET+DATA&releaseScheduleId=). However, the values were different from the original data they used for the paper(provided by Jake). The difference increases as year increases. The reason for that is still unclear. 

# Replicate the model for base 
According to the paper, the model follows the form of $y_t = b_1y_{t-1}+b12y_{t-12}+e_t$(AR-1 model). We used the codes below to obtain the same summary table to the model

```{r}
# load the data that was used for the paper
merged <- read_csv("merged.csv")

# take the log of all sales values
merged$sales<-log(merged$sales)

# apply lm(). lag() is used to capture y_t-1 and y_t-12
model1 <- lm(data = merged, sales~lag(sales, 1)+lag(sales,12))

#the summary of the model
summary(model1)
```
The summary we obtained is identical to the paper. 


# Replicate the model with trends
According to the paper, we added two trends, *Trucks & SUVs* and *Automotive Insurance* to the previous model. 

```{r}
# model with trends
model_with_trend <- lm(data = merged, sales~lag(sales, 1)+lag(sales,12) + suvs + insurance)

# summary table of the model
summary(model_with_trend)
```

Once again, The summary we obtained is identical to the paper.

# Replicate figure 2 

***Add explanations here***

```{r}
base <- merged
# creating base 
for (i in 18:91){
  merged_t <- merged[1:i-1,]
  model1 <- lm(data = merged_t, sales~lag(sales, 1)+lag(sales,12))
  base$sales[i] <- predict(model1,merged[1:i,])[i]
}
base <- base[18:91,]


# creating trends 

trends <- merged
for (i in 18:91){
  merged_t <- merged[1:i-1,]
  model1 <- lm(data = merged_t, sales~lag(sales, 1)+lag(sales,12)+ suvs + insurance)
  trends$sales[i] <- predict(model1,merged[1:i,])[i]
}
trends <- trends[18:91,]

# Make the graph

actual <- merged[18:91,]
actual <- actual %>% 
  mutate(label ="actual")
base <- base %>% 
  mutate(label = "base")
trends <- trends %>% 
  mutate(label ="trends")
plot_data <- rbind(actual, base, trends)
ggplot(plot_data, aes(x=Period, y = sales, color = label, linetype = label))+
  geom_line()+
  scale_colour_manual(values=c("black", "red","grey"))+
  scale_linetype_manual(values = c("solid", "dashed", "solid"))+
  ylab('log(mvp)')+
  xlab('Index')
```


# Calculate Mean Absolute Error and R^2

```{r}
# means absolute error
mean(abs(trends$sales-actual$sales))
mean(abs(base$sales-actual$sales))

# data for recession period Dec 2007 to June 2009
recession_trends <- trends %>% 
  filter(Period>="2007-12-01"& Period<="2009-06-01")
recession_base <- base %>% 
  filter(Period>="2007-12-01"& Period<="2009-06-01")
recession_actual <- actual %>% 
  filter(Period>="2007-12-01"& Period<="2009-06-01")
mean(abs(recession_trends$sales-recession_actual$sales))
mean(abs(recession_base$sales-recession_actual$sales))


# Overall improvement 
(mean(abs(base$sales-actual$sales))-mean(abs(trends$sales-actual$sales)))/mean(abs(base$sales-actual$sales))


# recession improvement
(mean(abs(recession_base$sales-recession_actual$sales))-mean(abs(recession_trends$sales-recession_actual$sales)))/mean(abs(recession_base$sales-recession_actual$sales))

#the improvements they stated in the paragraph were different from what they labeled on the graph. First, I thought they used some kind of function, but the MAE() from library(caret) gives same value.


#R^2 for base
(cor(base$sales,actual$sales))^2

# R^2 for trends
(cor(trends$sales,actual$sales))^2

library(caret)
 
# R native funcitons
MAE(recession_trends$sales, recession_actual$sales)
MAE(recession_base$sales, recession_actual$sales)

MAE(trends$sales, actual$sales)
MAE(base$sales, actual$sales)


```



# comparing data used in the paper with data we obtained from census.gov
We noticed that the sales from the data we obtained were always less than the data used in the paper. We want to find out why.

```{r}
# load the data
sales <- read_excel("sales.xls")
merged <- read_csv("merged.csv")
# Period is type char in the data, convert that to yearmonth 
ym <- as.yearmon(sales$Period, "%b-%Y")
# use as.Date() to convert ym into type date
sales$Period <- as.Date(ym)
#keep only data from 01/2004 through 07/2011 and renames the data frame as unadj, rename the column Value as sales,and add label "unadjusted"
unadj<- sales %>% 
  filter(Period <="2011-07-01") %>% 
  mutate(label = "unadjusted") %>% 
  rename(sales = Value)
# convert sales to numeric 
unadj$sales <-as.numeric(unadj$sales)
# add label to original data, keep only Period, sales and label
orig <- merged %>% 
  mutate(label = "original") %>% 
  select(-insurance, -suvs)
# stack two data frame
com_data <- rbind(unadj, orig)

#plot the data 
ggplot(com_data, aes(x=Period, y = sales, color = label)) +
  geom_line()
# log(sales)
ggplot(com_data, aes(x=Period, y = log(sales), color = label)) +
  geom_line()
# plot orignal against unadjusted

joined_data <- unadj %>% select(-label) %>% rename(unadjusted_sales = sales) %>% left_join(orig, by ="Period") %>% select(-label)

ggplot(joined_data, aes(x = sales, y = unadjusted_sales)) +
  geom_point()+
  geom_abline(linetype = "dashed") +
  xlab('original') +
  ylab('unadjusted')+
  ggtitle("original sales against unadjusted sales")
```

From the first first graph, we can see that the sales values from both original and unajusted are very close to each other(almost overlapping). When I plotted original against unadjusted, they almost line up on the diagonal. Note that original is always less than unadjusted. I wonder if people went modified that data after the authors obtained the data. Further investigation needed...


# How did they transformed the Google Trends
The next step of replication is trying to find out the transformation the authors did with the Google trends data they used. **Skipping for now**.



# Replicate all the results again with unadjusted data from census.gov
We would like to compare the outputs of unadjusted data with the outputs from the original data.


```{r}
#take the log of sales, take out the label column
unadj_rep <- unadj %>% mutate(sales=log(sales)) %>% select(-label)

# repliacte model of the base
model1 <- lm(data = unadj_rep, sales~lag(sales, 1)+lag(sales,12))
summary(model1)

# since we don't know how they transformed Google trends,we would use the same numbers from original data


# trends contains trends data and Period for join
google_trends <- merged %>% select(-sales)

# join trends to unadj_rep
unadj_with_trends <- unadj_rep %>% left_join(google_trends, by = "Period")


# replicate the model with trends
model_with_trend <- lm(data = unadj_with_trends, sales~lag(sales, 1)+lag(sales,12) + suvs + insurance)
summary(model_with_trend)

# replicate figure 2

# creating base 
base_unajusted <- unadj_with_trends
for (i in 18:91){
  merged_t <- unadj_with_trends[1:i-1,]
  model1 <- lm(data = merged_t, sales~lag(sales, 1)+lag(sales,12))
  base_unajusted$sales[i] <- predict(model1,unadj_with_trends[1:i,])[i]
}
base_unajusted <- base_unajusted[18:91,]


# creating trends 
trends_unajusted <- unadj_with_trends
for (i in 18:91){
  merged_t <- unadj_with_trends[1:i-1,]
  model1 <- lm(data = merged_t, sales~lag(sales, 1)+lag(sales,12) + suvs + insurance)
  trends_unajusted$sales[i] <- predict(model1,unadj_with_trends[1:i,])[i]
}
trends_unajusted <- trends_unajusted[18:91,]

# Make the graph

# label different data sets
actual_unajusted <- unadj_with_trends[18:91,]
actual_unajusted <- actual_unajusted %>%
  mutate(label ="actual_unajusted")
base_unajusted <- base_unajusted %>%
  mutate(label = "base_unajusted")
trends_unajusted <- trends_unajusted %>%
  mutate(label ="trends_unajusted")

# stack all data sets for plotting
plot_data <- rbind(actual_unajusted, base_unajusted, trends_unajusted)
ggplot(plot_data, aes(x=Period, y = sales, color = label, linetype = label))+
  geom_line()+
  scale_colour_manual(values=c("black", "red","grey"))+
  scale_linetype_manual(values = c("solid", "dashed", "solid"))+
  ylab('log(mvp)')+
  xlab('Index')
```


### R^2 for unadjusted data
```{r}
# R^2 for base
(cor(base_unajusted$sales,actual_unajusted$sales))^2

# R^2 for trends
(cor(trends_unajusted$sales,actual_unajusted$sales))^2

```


# Compare Figure 2 from original and unadjusted data
By looking at the graph, we're not sure about the similarity of the figure 2, so I decided to graph them on the same graph.

```{r}
plot_data <- rbind(actual, base, trends, actual_unajusted, base_unajusted, trends_unajusted)
ggplot(plot_data, aes(x=Period, y = sales, color = label, linetype = label))+
  geom_line()+
  scale_colour_manual(values=c("black","black", "red","red","grey","grey"))+
  scale_linetype_manual(values = c("solid","solid","dashed", "dashed", "solid","solid"))+
  ylab('log(mvp)')+
  xlab('Index')
```

We see very small difference when comparing original data and unadjusted data. We will use unadjusted data for further exploration.


# Add trends from Google Trends without unknown transformations 

### 2004 - 2011

```{r}
suvs_trends <- read_csv("New_Trucks_suvs.csv")
insurance_trends <- read_csv("New_Trucks_suvs.csv")
# rename
names1<- names(suvs_trends)
names2 <- names(insurance_trends)
suvs_trends <- suvs_trends %>% 
  rename(suvs = names1[2],
         Period = Month)
insurance_trends <- insurance_trends %>% 
  rename(insurance = names2[2], 
         Period = Month)

unadj_full <- sales %>% filter(Period <= "2011-07-01")

trends_full <- left_join(insurance_trends, suvs_trends, by = "Period") %>% mutate(Period = as.Date(as.yearmon(Period, "%Y-%m"))) 
with_trends_full <- left_join(unadj_full, trends_full, by = "Period") %>% rename(sales = Value) 
with_trends_full$sales = log(as.numeric(with_trends_full$sales))

# apply lm(). lag() is used to capture y_t-1 and y_t-12
model1 <- lm(data = with_trends_full, sales~lag(sales, 1)+lag(sales,12))

#the summary of the model
summary(model1)


# model with trends
model_with_trend <- lm(data = with_trends_full, sales~lag(sales, 1)+lag(sales,12) + suvs + insurance)

# summary table of the model
summary(model_with_trend)


```

From the summary of the model we know that they suvs and insurance do not contribute to the model.

### 2004 -2020 

```{r}
suvs_trends <- read_csv("trucks_suvs_2004_2020.csv")
insurance_trends <- read_csv("auto_insurance_2004_2020.csv")
# rename
names1<- names(suvs_trends)
names2 <- names(insurance_trends)
suvs_trends <- suvs_trends %>% 
  rename(suvs = names1[2],
         Period = Month)
insurance_trends <- insurance_trends %>% 
  rename(insurance = names2[2], 
         Period = Month)

unadj_full <- sales %>% filter(Period <= "2020-05-01")

trends_full <- left_join(insurance_trends, suvs_trends, by = "Period") %>% mutate(Period = as.Date(as.yearmon(Period, "%Y-%m"))) 
with_trends_full <- left_join(unadj_full, trends_full, by = "Period") %>% rename(sales = Value) 
with_trends_full$sales = log(as.numeric(with_trends_full$sales))

# apply lm(). lag() is used to capture y_t-1 and y_t-12
model1 <- lm(data = with_trends_full, sales~lag(sales, 1)+lag(sales,12))

#the summary of the model
summary(model1)


# model with trends
model_with_trend <- lm(data = with_trends_full, sales~lag(sales, 1)+lag(sales,12) + suvs + insurance)

# summary table of the model
summary(model_with_trend)
```


# An attempt to find the Google Trends used in the paper

```{r}
# trend 1
# suvs_trends <- read_csv("suvs_2004_2011_all_cat.csv")
# names1<- names(suvs_trends)
# suvs_trends <- suvs_trends %>%
#   rename(suvs = names1[2],
#          Period = Month) %>% 
#   mutate(suvs = (suvs-suvs[1])/max(suvs))

# trend 2
insurance_trends <- read_csv("New_auto_insurance.csv")
names2 <- names(insurance_trends)

insurance_trends <- insurance_trends %>%
  rename(insurance = names2[2],
         Period = Month)%>%
   mutate(insurance=(insurance-insurance[1])/max(insurance))

# trend 3
  trucks_trends <- read_csv("New_Trucks_suvs.csv")
names3 <- names(trucks_trends)

trucks_trends <- trucks_trends %>%
  rename(trucks = names3[2],
         Period = Month) %>%
   mutate(trucks=(trucks-trucks[1])/max(trucks))

unadj_full <- sales %>% filter(Period <= "2011-07-01")

trends_full <- left_join(insurance_trends, trucks_trends, by = "Period") %>% mutate(Period = as.Date(as.yearmon(Period, "%Y-%m")))
# trends_2 <- left_join(insurance_trends, suvs_trends, by = "Period") 
# trends_full <- left_join(trends_2, trucks_trends, by = "Period") %>% mutate(Period = as.Date(as.yearmon(Period, "%Y-%m")))
#trends_full <- insurance_trends %>% mutate(Period = as.Date(as.yearmon(Period, "%Y-%m"))) 
#trends_full <- trucks_trends %>% mutate(Period = as.Date(as.yearmon(Period, "%Y-%m"))) 

with_trends_full <- left_join(unadj_full, trends_full, by = "Period") %>% rename(sales = Value) 
with_trends_full$sales = log(as.numeric(with_trends_full$sales))


# apply lm(). lag() is used to capture y_t-1 and y_t-12
model1 <- lm(data = with_trends_full, sales~lag(sales, 1)+lag(sales,12))

#the summary of the model
summary(model1)



# model with trends

model_with_trend <- lm(data = with_trends_full, sales~lag(sales, 1)+lag(sales,12) + insurance+ trucks)

#model_with_trend <- lm(data = with_trends_full, sales~lag(sales, 1)+lag(sales,12) + trucks)

# summary table of the model
summary(model_with_trend)


## trying the transformation on trends

#with_trends_full %>% View
```








```{r}
# trend 1
suvs_trends <- read_csv("New_Trucks_suvs.csv")
names1<- names(suvs_trends)
suvs_trends <- suvs_trends %>%
  rename(suvs = names1[2],
         Period = Month) %>%
  mutate(suvs = (suvs-suvs[1])/max(suvs))

# trend 2
insurance_trends <- read_csv("New_auto_insurance.csv")
names2 <- names(insurance_trends)

insurance_trends <- insurance_trends %>%
  rename(insurance = names2[2],
         Period = Month)


unadj_full <- sales %>% filter(Period <= "2011-07-01")

trends_full <- left_join(insurance_trends, suvs_trends, by = "Period") %>% mutate(Period = as.Date(as.yearmon(Period, "%Y-%m")))
# trends_2 <- left_join(insurance_trends, suvs_trends, by = "Period") 
# trends_full <- left_join(trends_2, trucks_trends, by = "Period") %>% mutate(Period = as.Date(as.yearmon(Period, "%Y-%m")))
#trends_full <- insurance_trends %>% mutate(Period = as.Date(as.yearmon(Period, "%Y-%m"))) 
#trends_full <- trucks_trends %>% mutate(Period = as.Date(as.yearmon(Period, "%Y-%m"))) 

with_trends_full <- left_join(unadj_full, trends_full, by = "Period") %>% rename(sales = Value) 
with_trends_full$sales = log(as.numeric(with_trends_full$sales))


# apply lm(). lag() is used to capture y_t-1 and y_t-12
model1 <- lm(data = with_trends_full, sales~lag(sales, 1)+lag(sales,12))

#the summary of the model
summary(model1)



# model with trends

model_with_trend <- lm(data = with_trends_full, sales~lag(sales, 1)+lag(sales,12) + insurance+ suvs)

#model_with_trend <- lm(data = with_trends_full, sales~lag(sales, 1)+lag(sales,12) + trucks)

# summary table of the model
summary(model_with_trend)


## trying the transformation on trends

#with_trends_full %>% View
```
